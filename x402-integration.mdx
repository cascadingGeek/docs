---
title: "x402 Integration Guide"
description: "Complete guide for integrating x402 v1 and v2 with 0xmeta facilitator"
---

## Overview 

0xmeta supports both **x402 v1** (legacy) and **x402 v2** (current) protocols with **post-settlement fee collection** to maintain trust-minimization.

<Note>
**Trust-Minimized:** Customer payments go DIRECTLY to your address. The $0.01 fee is collected separately from your pre-approved USDC balance.
</Note>

---

## Quick Start

### Prerequisites

1. **Merchant wallet** with USDC on Base
2. **Approve facilitator** for USDC spending (one-time setup)
3. **x402 express middleware** installed

### Three-Step Setup

<Steps>
  <Step title="Approve Facilitator">
    ```bash
    # One-time setup
    EVM_PRIVATE_KEY=0x... node approve-facilitator.mjs
    ```
    
    Approves facilitator treasury to collect $0.01 fees from your USDC balance.
  </Step>
  
  <Step title="Configure Server">
    ```typescript
    // Use YOUR address in payTo (not treasury)
    {
      "GET /resource": {
        accepts: [{
          price: "$0.02",
          payTo: "0xYOUR_MERCHANT_ADDRESS" // ‚Üê Your address
        }]
      }
    }
    ```
  </Step>
  
  <Step title="Start Accepting Payments">
    ```bash
    npm start
    ```
    
    Customers pay directly to your address. Facilitator collects fee from your approved balance.
  </Step>
</Steps>

---

## Payment Flow

```mermaid
sequenceDiagram
    participant Client
    participant Merchant
    participant Facilitator

    Note over Merchant: ONE-TIME SETUP
    Merchant->>Facilitator: approve(treasury, 100 USDC)
    
    Client->>Merchant: 1. GET /resource
    Merchant-->>Client: 2. 402 Payment Required<br/>payTo: merchant_address
    
    Client->>Client: 3. Sign authorization<br/>to: merchant_address
    
    Client->>Facilitator: 4. Verify + Settle
    
    Facilitator->>Facilitator: 5. Collect $0.01 fee<br/>from merchant
    
    Facilitator->>Merchant: 6. Execute settlement<br/>client ‚Üí merchant
    
    Merchant-->>Client: 7. 200 OK + Resource
```

**Key Points:**
- ‚úÖ Client pays DIRECTLY to merchant ($0.02)
- ‚úÖ Merchant receives 100% of customer payment
- ‚úÖ Facilitator collects $0.01 fee from merchant's pre-approved balance
- ‚úÖ No facilitator custody of customer funds

---

## x402 v2 Integration (Recommended)

### Installation

```bash
npm install @x402/express @x402/evm @x402/core
```

### Complete Server Example

<CodeGroup>

```typescript server.ts
import { config } from "dotenv";
import express from "express";
import { paymentMiddleware, x402ResourceServer } from "@x402/express";
import { ExactEvmScheme } from "@x402/evm/exact/server";
import { HTTPFacilitatorClient } from "@x402/core/server";

config();

const evmAddress = process.env.EVM_ADDRESS as `0x${string}`;

if (!evmAddress) {
  console.error("Missing EVM_ADDRESS environment variable");
  process.exit(1);
}

const facilitatorUrl = process.env.FACILITATOR_URL;
if (!facilitatorUrl) {
  console.error("‚ùå FACILITATOR_URL environment variable is required");
  process.exit(1);
}

const facilitatorClient = new HTTPFacilitatorClient({ url: facilitatorUrl });
const app = express();

// Apply x402 payment middleware
app.use(
  paymentMiddleware(
    {
      "GET /weather": {
        accepts: [
          {
            scheme: "exact",
            price: "$0.02",                // Your price: $0.01 resource + $0.01 fee
            network: "eip155:8453",         // Base Mainnet
            payTo: evmAddress,              // ‚úÖ YOUR merchant address
          },
        ],
        description: "Weather data",
        mimeType: "application/json",
      },
    },
    new x402ResourceServer(facilitatorClient)
      .register("eip155:8453", new ExactEvmScheme()),
  ),
);

app.get("/weather", (req, res) => {
  res.send({
    report: {
      weather: "sunny",
      temperature: 70,
    },
  });
});

app.listen(4021, () => {
  console.log(`üöÄ Server listening at http://localhost:4021`);
});
```

```env .env
# ‚úÖ YOUR merchant address (receives customer payments)
EVM_ADDRESS=0xA821f428Ef8cC9f54A9915336A82220853059090

# ‚úÖ Private key (for one-time approval setup only)
EVM_PRIVATE_KEY=0x...

# Facilitator endpoint
FACILITATOR_URL=https://facilitator.0xmeta.ai/v1
```

</CodeGroup>

---

## x402 v1 Integration (Legacy)

### Installation

```bash
npm install x402-express
```

### Complete Server Example

<CodeGroup>

```typescript server-v1.ts
import { config } from "dotenv";
import express from "express";
import { paymentMiddleware, Resource, type SolanaAddress } from "x402-express";

config(); 

const facilitatorUrl = process.env.FACILITATOR_URL as Resource;
const payTo = process.env.EVM_ADDRESS as `0x${string}` | SolanaAddress;

if (!facilitatorUrl || !payTo) {
  console.error("Missing required environment variables");
  process.exit(1);
}

const app = express();

app.use(
  paymentMiddleware(
    payTo,  // ‚úÖ YOUR merchant address
    {
      "GET /weather": {
        price: "$0.02",          // $0.01 resource + $0.01 fee
        network: "base",         // Base Mainnet
      },
      "/premium/*": {
        // Or define atomic amounts
        price: {
          amount: "20000",       // 0.02 USDC (6 decimals)
          asset: {
            address: "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913",
            decimals: 6,
            eip712: {
              name: "USDC",
              version: "2",
            },
          },
        },
        network: "base",
      },
    },
    {
      url: facilitatorUrl,
    },
  ),
);

app.get("/weather", (req, res) => {
  res.send({
    report: {
      weather: "sunny",
      temperature: 70,
    },
  });
});

app.get("/premium/content", (req, res) => {
  res.send({
    content: "This is premium content",
  });
});

app.listen(4021, () => {
  console.log(`Server listening at http://localhost:4021`);
});
```

```env .env
# ‚úÖ YOUR merchant address
EVM_ADDRESS=0xA821f428Ef8cC9f54A9915336A82220853059090

# ‚úÖ Private key (one-time approval setup)
EVM_PRIVATE_KEY=0x...

# Facilitator URL
FACILITATOR_URL=https://facilitator.0xmeta.ai/v1

# Network
NETWORK=base
```

</CodeGroup>

---

## Merchant Approval Setup

### Why Approval Is Required

The facilitator collects a $0.01 fee per settlement from your USDC balance via `transferFrom`. This requires one-time approval.

**Technical details:**
```solidity
// You approve facilitator treasury
USDC.approve(treasury, 100 * 10^6); // 100 USDC

// Facilitator collects fee before settlement
USDC.transferFrom(merchant, treasury, 0.01 * 10^6); // $0.01
```

### approve-facilitator.mjs

<CodeGroup>

```javascript approve-facilitator.mjs
import { ethers } from "ethers";
import dotenv from "dotenv";
dotenv.config();

const NETWORKS = {
  sepolia: {
    name: "Base Sepolia",
    rpc: "https://sepolia.base.org",
    chainId: 84532,
    usdc: "0x036CbD53842c5426634e7929541eC2318f3dCF7e",
  },
  mainnet: {
    name: "Base Mainnet",
    rpc: "https://mainnet.base.org",
    chainId: 8453,
    usdc: "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913",
  },
};

const OXMETA_TREASURY = "0x5D791e3554D0e83f171126905Bda1640Bf6f9A8B";

const USDC_ABI = [
  "function approve(address spender, uint256 amount) external returns (bool)",
  "function allowance(address owner, address spender) external view returns (uint256)",
];

async function approveFacilitator() {
  const networkKey = process.env.NETWORK || "sepolia";
  const network = NETWORKS[networkKey];
  
  const privateKey = process.env.EVM_PRIVATE_KEY;
  if (!privateKey) {
    console.error("‚ùå EVM_PRIVATE_KEY required in .env");
    process.exit(1);
  }
  
  const provider = new ethers.JsonRpcProvider(network.rpc);
  const merchant = new ethers.Wallet(privateKey, provider);
  
  console.log(`\nüìç ${network.name}`);
  console.log(`   Merchant: ${merchant.address}`);
  console.log(`   Treasury: ${OXMETA_TREASURY}`);
  
  const usdc = new ethers.Contract(network.usdc, USDC_ABI, merchant);
  
  // Approve 100 USDC (10,000 settlements)
  const approvalAmount = ethers.parseUnits("100", 6);
  
  console.log(`\nüí∞ Approving 100 USDC for fee collection...`);
  
  const tx = await usdc.approve(OXMETA_TREASURY, approvalAmount);
  console.log(`   Transaction: ${tx.hash}`);
  
  await tx.wait();
  console.log(`‚úÖ Approval successful!`);
  
  // Verify
  const allowance = await usdc.allowance(merchant.address, OXMETA_TREASURY);
  console.log(`   Allowance: ${ethers.formatUnits(allowance, 6)} USDC`);
  console.log(`   Settlements: ~${Math.floor(Number(ethers.formatUnits(allowance, 6)) / 0.01)}`);
}

approveFacilitator().catch(console.error);
```

```bash Usage
# Approve on Base Sepolia (testnet)
NETWORK=sepolia node approve-facilitator.mjs

# Approve on Base Mainnet (production)
NETWORK=mainnet node approve-facilitator.mjs
```

</CodeGroup>

**Expected Output:**
```
üìç Base Sepolia
   Merchant: 0xA821f428Ef8cC9f54A9915336A82220853059090
   Treasury: 0x5D791e3554D0e83f171126905Bda1640Bf6f9A8B

üí∞ Approving 100 USDC for fee collection...
   Transaction: 0x123...
‚úÖ Approval successful!
   Allowance: 100.0 USDC
   Settlements: ~10000
```

---

## Monitoring Allowance

### check-allowance.mjs

<CodeGroup>

```javascript check-allowance.mjs
import { ethers } from "ethers";
import dotenv from "dotenv";
dotenv.config();

const NETWORKS = {
  sepolia: {
    name: "Base Sepolia",
    rpc: "https://sepolia.base.org",
    usdc: "0x036CbD53842c5426634e7929541eC2318f3dCF7e",
  },
  mainnet: {
    name: "Base Mainnet",
    rpc: "https://mainnet.base.org",
    usdc: "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913",
  },
};

const OXMETA_TREASURY = "0x5D791e3554D0e83f171126905Bda1640Bf6f9A8B";

const USDC_ABI = [
  "function allowance(address owner, address spender) external view returns (uint256)",
  "function balanceOf(address account) external view returns (uint256)",
];

async function checkNetwork(networkKey, merchantAddress) {
  const network = NETWORKS[networkKey];
  const provider = new ethers.JsonRpcProvider(network.rpc);
  const usdc = new ethers.Contract(network.usdc, USDC_ABI, provider);
  
  const [allowance, balance] = await Promise.all([
    usdc.allowance(merchantAddress, OXMETA_TREASURY),
    usdc.balanceOf(merchantAddress),
  ]);
  
  const allowanceFormatted = ethers.formatUnits(allowance, 6);
  const balanceFormatted = ethers.formatUnits(balance, 6);
  const settlements = Math.floor(Number(allowanceFormatted) / 0.01);
  
  console.log(`\nüìç ${network.name}`);
  console.log(`   USDC Balance: ${balanceFormatted} USDC`);
  console.log(`   Fee Allowance: ${allowanceFormatted} USDC`);
  console.log(`   Settlements Remaining: ${settlements}`);
  
  if (settlements < 10) {
    console.log(`   ‚ö†Ô∏è  Low - run: NETWORK=${networkKey} node approve-facilitator.mjs`);
  } else if (settlements < 50) {
    console.log(`   ‚ö†Ô∏è  Getting low`);
  } else {
    console.log(`   ‚úÖ Good`);
  }
}

async function main() {
  const merchantAddress = process.env.EVM_ADDRESS;
  
  if (!merchantAddress) {
    console.error("‚ùå Set EVM_ADDRESS in .env");
    process.exit(1);
  }
  
  console.log("=".repeat(60));
  console.log("0xmeta Facilitator Fee Allowance Check");
  console.log("=".repeat(60));
  console.log(`\nüë§ Merchant: ${merchantAddress}`);
  console.log(`üè¶ Treasury: ${OXMETA_TREASURY}`);
  
  const networkArg = process.argv[2] || "both";
  
  if (networkArg === "both") {
    await checkNetwork("sepolia", merchantAddress);
    await checkNetwork("mainnet", merchantAddress);
  } else {
    await checkNetwork(networkArg, merchantAddress);
  }
  
  console.log("\n" + "=".repeat(60));
}

main().catch(console.error);
```

```bash Usage
# Check both networks
node check-allowance.mjs

# Check specific network
node check-allowance.mjs sepolia
node check-allowance.mjs mainnet
```

</CodeGroup>

**Expected Output:**
```
============================================================
0xmeta Facilitator Fee Allowance Check
============================================================

üë§ Merchant: 0xA821f428Ef8cC9f54A9915336A82220853059090
üè¶ Treasury: 0x5D791e3554D0e83f171126905Bda1640Bf6f9A8B

üìç Base Sepolia
   USDC Balance: 500.00 USDC
   Fee Allowance: 95.50 USDC
   Settlements Remaining: 9550
   ‚úÖ Good

üìç Base Mainnet
   USDC Balance: 1000.00 USDC
   Fee Allowance: 0.00 USDC
   Settlements Remaining: 0
   ‚ö†Ô∏è  Low - run: NETWORK=mainnet node approve-facilitator.mjs

============================================================
```

---

## Network Configuration

### Base Sepolia (Testnet)

| Resource | Value |
|----------|-------|
| **Chain ID** | `84532` |
| **CAIP-2** | `eip155:84532` |
| **USDC** | `0x036CbD53842c5426634e7929541eC2318f3dCF7e` |
| **Treasury** | `0x5D791e3554D0e83f171126905Bda1640Bf6f9A8B` |
| **RPC** | `https://sepolia.base.org` |

### Base Mainnet (Production)

| Resource | Value |
|----------|-------|
| **Chain ID** | `8453` |
| **CAIP-2** | `eip155:8453` |
| **USDC** | `0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913` |
| **Treasury** | `0x5D791e3554D0e83f171126905Bda1640Bf6f9A8B` |
| **RPC** | `https://mainnet.base.org` |

---

## Error Handling

### Insufficient Allowance

If merchant hasn't approved facilitator:

```json
{
  "error": {
    "code": "insufficient_allowance",
    "message": "Merchant must approve facilitator for USDC spending",
    "details": {
      "required": "10000",
      "available": "0",
      "approval_command": "node approve-facilitator.mjs"
    }
  }
}
```

**Solution:**
```bash
EVM_PRIVATE_KEY=0x... node approve-facilitator.mjs
```

### Fee Collection Failed

If merchant has insufficient USDC balance:

```json
{
  "error": {
    "code": "fee_collection_failed",
    "message": "Could not collect $0.01 fee from merchant",
    "details": {
      "reason": "Insufficient USDC balance"
    }
  }
}
```

**Solution:** Add USDC to merchant address.

---

## Best Practices

<AccordionGroup>
  <Accordion title="Approve Reasonable Amounts">
    **Recommended:** 100-1000 USDC (10,000-100,000 settlements)
    
    **Avoid:** Infinite approval (max uint256)
    
    **Why:** Limits exposure if facilitator compromised
  </Accordion>

  <Accordion title="Monitor Allowance Regularly">
    Set up automated checks:
    
    ```bash
    # Cron job to check daily
    0 9 * * * node check-allowance.mjs
    ```
  </Accordion>

  <Accordion title="Test on Sepolia First">
    Always test on testnet before mainnet:
    
    ```bash
    # 1. Approve on Sepolia
    NETWORK=sepolia node approve-facilitator.mjs
    
    # 2. Test settlements
    npm run test
    
    # 3. Then approve on mainnet
    NETWORK=mainnet node approve-facilitator.mjs
    ```
  </Accordion>

  <Accordion title="Maintain USDC Balance">
    Ensure sufficient USDC for fees:
    
    - Minimum: 1 USDC (100 settlements)
    - Recommended: Match approval amount
  </Accordion>
</AccordionGroup>

---

## FAQ

<AccordionGroup>
  <Accordion title="Why do I need to approve the facilitator?">
    The facilitator collects a $0.01 fee per settlement from your USDC balance via `transferFrom`. This is a standard ERC-20 pattern that requires approval.
  </Accordion>

  <Accordion title="Can the facilitator access all my USDC?">
    **No.** Only the approved amount is accessible. Approve 100 USDC ‚Üí max risk is 100 USDC.
  </Accordion>

  <Accordion title="What if I revoke approval?">
    Future settlements will fail with `insufficient_allowance` error. Customers won't be charged.
  </Accordion>

  <Accordion title="Why not collect fee from customer?">
    x402 requires customer payments go directly to merchants (trust-minimization). We can't split customer payments, so merchants pay the fee separately.
  </Accordion>

  <Accordion title="What happens if settlement fails after fee?">
    You paid $0.01 for the settlement attempt. This prevents free service exploitation.
  </Accordion>
</AccordionGroup>

---

## Next Steps

<CardGroup cols={2}>
  <Card title="Architecture" icon="diagram-project" href="/architecture">
    Understand payment flow
  </Card>
  
  <Card title="API Reference" icon="book" href="/api-reference/introduction">
    Explore endpoints
  </Card>
  
  <Card title="Pricing" icon="dollar-sign" href="/pricing">
    Fee structure details
  </Card>
  
  <Card title="FAQ" icon="question" href="/faq">
    Common questions
  </Card>
</CardGroup>

<Check>
**You're ready!** Approve the facilitator, configure your server with YOUR merchant address, and start accepting payments.
</Check>