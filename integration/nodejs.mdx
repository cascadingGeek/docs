---
title: "Node.js Integration"
description: "Complete guide to integrating 0xmeta with Node.js using x402/express"
---

## Overview

0xmeta facilitator supports both **x402 v1** (legacy) and **x402 v2** (current) protocols. This guide shows you how to integrate using the x402 express middleware.

<Note>
**Recommended:** Use x402 v2 for new projects. It provides better network identification with CAIP-2 format.
</Note>

---

## Quick Start

### Installation

<CodeGroup>

```bash x402 v2 (Recommended)
npm install @x402/express @x402/evm @x402/core express dotenv
```

```bash x402 v1 (Legacy)
npm install x402-express express dotenv
```

</CodeGroup>

---

## x402 v2 Integration (Recommended)

### Complete Server Example

<CodeGroup>

```typescript server.ts
import { config } from "dotenv";
import express from "express";
import { paymentMiddleware, x402ResourceServer } from "@x402/express";
import { ExactEvmScheme } from "@x402/evm/exact/server";
import { HTTPFacilitatorClient } from "@x402/core/server";

config();

const evmAddress = process.env.EVM_ADDRESS as `0x${string}`;

if (!evmAddress) {
  console.error("Missing required environment variables");
  process.exit(1);
}

const facilitatorUrl = process.env.FACILITATOR_URL;
if (!facilitatorUrl) {
  console.error("❌ FACILITATOR_URL environment variable is required");
  process.exit(1);
}

const facilitatorClient = new HTTPFacilitatorClient({ url: facilitatorUrl });
const app = express();

app.use(
  paymentMiddleware(
    {
      "GET /weather": {
        accepts: [
          {
            scheme: "exact",
            price: "$0.011",              // Your price + $0.01 fee
            network: "eip155:84532",      // Base Sepolia (CAIP-2 format)
            payTo: evmAddress,            // Treasury address from /supported
          },
        ],
        description: "Weather data",
        mimeType: "application/json",
      },
    },
    new x402ResourceServer(facilitatorClient)
      .register("eip155:84532", new ExactEvmScheme()),
  ),
);

app.get("/weather", (req, res) => {
  res.send({
    report: {
      weather: "sunny",
      temperature: 70,
    },
  });
});

app.listen(4021, () => {
  console.log(`Server listening at http://localhost:4021`);
});
```

```env .env
# ✅ CRITICAL: Use treasury address, NOT your merchant address
# Get from: curl https://facilitator.0xmeta.ai/v1/supported
EVM_ADDRESS=0x5d791e3554d0e83f171126905bda1640bf6f9a8b

# Facilitator endpoint
FACILITATOR_URL=https://facilitator.0xmeta.ai/v1
```

```json package.json
{
  "name": "x402-server",
  "version": "1.0.0",
  "type": "module",
  "scripts": {
    "start": "tsx server.ts",
    "dev": "tsx watch server.ts"
  },
  "dependencies": {
    "@x402/express": "latest",
    "@x402/evm": "latest",
    "@x402/core": "latest",
    "express": "^4.18.0",
    "dotenv": "^16.0.0"
  },
  "devDependencies": {
    "tsx": "latest",
    "@types/express": "latest",
    "@types/node": "latest"
  }
}
```

</CodeGroup>

### Running the Server

```bash
# Install dependencies
npm install

# Start server
npm start
```

**Expected output:**
```
Server listening at http://localhost:4021
```

---

## x402 v1 Integration (Legacy)

### Complete Server Example

<CodeGroup>

```typescript server-v1.ts
import { config } from "dotenv";
import express from "express";
import { paymentMiddleware, Resource, type SolanaAddress } from "x402-express";

config(); 

const facilitatorUrl = process.env.FACILITATOR_URL as Resource;
const payTo = process.env.EVM_ADDRESS as `0x${string}` | SolanaAddress;

if (!facilitatorUrl || !payTo) {
  console.error("Missing required environment variables");
  process.exit(1);
}

const app = express();

app.use(
  paymentMiddleware(
    payTo,  // Treasury address (first parameter in v1)
    {
      "GET /weather": {
        price: "$0.011",            // USDC amount in dollars
        network: "base-sepolia",     // Network name (v1 format)
      },
      "/premium/*": {
        // Can also define atomic amounts
        price: {
          amount: "100000",
          asset: {
            address: "0x036CbD53842c5426634e7929541eC2318f3dCF7e",
            decimals: 6,
            eip712: {
              name: "USDC",
              version: "2",
            },
          },
        },
        network: "base-sepolia",
      },
    },
    {
      url: facilitatorUrl,
    },
  ),
);

app.get("/weather", (req, res) => {
  res.send({
    report: {
      weather: "sunny",
      temperature: 70,
    },
  });
});

app.get("/premium/content", (req, res) => {
  res.send({
    content: "This is premium content",
  });
});

app.listen(4021, () => {
  console.log(`Server listening at http://localhost:4021`);
});
```

```env .env
EVM_ADDRESS=0x5d791e3554d0e83f171126905bda1640bf6f9a8b
FACILITATOR_URL=https://facilitator.0xmeta.ai/v1
```

```json package.json
{
  "name": "x402-server-v1",
  "version": "1.0.0",
  "type": "module",
  "scripts": {
    "start": "tsx server.ts"
  },
  "dependencies": {
    "x402-express": "latest",
    "express": "^4.18.0",
    "dotenv": "^16.0.0"
  },
  "devDependencies": {
    "tsx": "latest",
    "@types/express": "latest"
  }
}
```

</CodeGroup>

---

## Understanding Treasury Address

### Why Treasury Address?

<Warning>
**Critical:** You must use 0xmeta's treasury address in `payTo`, NOT your merchant address.
</Warning>

**Technical reason:** EIP-3009 signatures are cryptographically bound to a specific recipient. To collect fees atomically, clients must authorize payments to the treasury, which then forwards to your address.

### Getting Treasury Address

**Option 1: From /supported endpoint**

```bash
curl https://facilitator.0xmeta.ai/v1/supported
```

Response:
```json
{
  "kinds": [...],
  "signers": {
    "eip155:*": ["0x5d791e3554d0e83f171126905bda1640bf6f9a8b"]
  }
}
```

✅ Use `signers["eip155:*"][0]` as your `EVM_ADDRESS`

**Option 2: Hardcode (not recommended)**

```typescript
const TREASURY_ADDRESS = "0x5d791e3554d0e83f171126905bda1640bf6f9a8b";
```

<Tip>
Query `/supported` programmatically on server startup for dynamic treasury discovery.
</Tip>

---

## Multiple Resources

### Protecting Multiple Endpoints

<CodeGroup>

```typescript v2 - Multiple Routes
app.use(
  paymentMiddleware(
    {
      "GET /weather": {
        accepts: [{
          scheme: "exact",
          price: "$0.011",
          network: "eip155:84532",
          payTo: evmAddress,
        }],
        description: "Current weather",
      },
      
      "GET /forecast": {
        accepts: [{
          scheme: "exact",
          price: "$0.021",              // Different price
          network: "eip155:84532",
          payTo: evmAddress,
        }],
        description: "7-day forecast",
      },
      
      "POST /analysis": {
        accepts: [{
          scheme: "exact",
          price: "$0.101",              // Higher price
          network: "eip155:84532",
          payTo: evmAddress,
        }],
        description: "Weather analysis",
      },
    },
    new x402ResourceServer(facilitatorClient)
      .register("eip155:84532", new ExactEvmScheme()),
  ),
);
```

```typescript v1 - Multiple Routes
app.use(
  paymentMiddleware(
    payTo,
    {
      "GET /weather": {
        price: "$0.011",
        network: "base-sepolia",
      },
      "GET /forecast": {
        price: "$0.021",
        network: "base-sepolia",
      },
      "/premium/*": {
        price: "$0.101",
        network: "base-sepolia",
      },
    },
    { url: facilitatorUrl },
  ),
);
```

</CodeGroup>

---

## Network Configuration

### Supported Networks

| x402 v1 | x402 v2 | Chain ID | Network |
|---------|---------|----------|---------|
| `"base-sepolia"` | `"eip155:84532"` | 84532 | Base Sepolia (Testnet) |
| `"base"` | `"eip155:8453"` | 8453 | Base Mainnet |

### Production vs Development

<CodeGroup>

```typescript Development (Base Sepolia)
// v2
network: "eip155:84532"

// v1
network: "base-sepolia"
```

```typescript Production (Base Mainnet)
// v2
network: "eip155:8453"

// v1
network: "base"
```

</CodeGroup>

---

## Testing Your Integration

### Test with x402 Client

<CodeGroup>

```typescript client.ts
import { config } from "dotenv";
import { x402Client, wrapAxiosWithPayment } from "@x402/axios";
import { registerExactEvmScheme } from "@x402/evm/exact/client";
import { privateKeyToAccount } from "viem/accounts";
import axios from "axios";

config();

const evmPrivateKey = process.env.EVM_PRIVATE_KEY as `0x${string}`;
const baseURL = "http://localhost:4021";
const url = `${baseURL}/weather`;

async function main(): Promise<void> {
  const evmSigner = privateKeyToAccount(evmPrivateKey);

  const client = new x402Client();
  registerExactEvmScheme(client, { signer: evmSigner });

  const api = wrapAxiosWithPayment(axios.create(), client);

  console.log(`Making request to: ${url}\n`);
  const response = await api.get(url);
  
  console.log("Response:", response.data);
}

main().catch(console.error);
```

```bash Run Test
npm run test:client
```

</CodeGroup>

### Expected Flow

```
1. ✅ Client requests /weather
2. ✅ Server returns 402 with treasury address
3. ✅ Client creates EIP-3009 authorization to treasury
4. ✅ Client sends authorization to server
5. ✅ Server forwards to facilitator for verification
6. ✅ Facilitator verifies signature
7. ✅ Facilitator settles payment
   a. Client → Treasury ($0.011)
   b. Treasury → Merchant ($0.001, automatic)
8. ✅ Server returns 200 + weather data
```

---

## Error Handling

### Common Issues

<AccordionGroup>
  <Accordion title="Error: Payment must be to treasury, not merchant">
    **Cause:** Server is configured with merchant address
    
    **Solution:**
    ```bash
    # Get treasury address
    curl https://facilitator.0xmeta.ai/v1/supported
    
    # Update .env
    EVM_ADDRESS=0x5d791e3554d0e83f171126905bda1640bf6f9a8b  # Treasury
    ```
  </Accordion>

  <Accordion title="Error: Invalid network">
    **Cause:** Network format mismatch
    
    **Solution:**
    - v2: Use CAIP-2 format (`eip155:84532`)
    - v1: Use string format (`base-sepolia`)
  </Accordion>

  <Accordion title="Error: FACILITATOR_URL not set">
    **Cause:** Missing environment variable
    
    **Solution:**
    ```env
    FACILITATOR_URL=https://facilitator.0xmeta.ai/v1
    ```
  </Accordion>

  <Accordion title="Settlement fails: authorization expired">
    **Cause:** Client's `validBefore` too short
    
    **Solution:** Client should set longer validity:
    ```javascript
    validBefore: String(Math.floor(Date.now() / 1000) + 86400)  // 24 hours
    ```
  </Accordion>
</AccordionGroup>

---

## Advanced Configuration

### Dynamic Pricing

```typescript
// Calculate price based on resource complexity
function calculatePrice(resource: string): string {
  const baseFee = 0.01;  // Facilitator fee
  
  const prices: Record<string, number> = {
    "/weather": 0.001,
    "/forecast": 0.01,
    "/analysis": 0.10,
  };
  
  const resourcePrice = prices[resource] || 0.001;
  const total = resourcePrice + baseFee;
  
  return `$${total.toFixed(3)}`;
}

app.use(
  paymentMiddleware(
    {
      "GET /weather": {
        accepts: [{
          price: calculatePrice("/weather"),  // $0.011
          network: "eip155:84532",
          payTo: evmAddress,
        }]
      },
    },
    facilitatorClient
  ),
);
```

### Custom Middleware

```typescript
// Add logging or analytics
import { NextFunction, Request, Response } from "express";

function loggingMiddleware(req: Request, res: Response, next: NextFunction) {
  console.log(`${req.method} ${req.path} - ${new Date().toISOString()}`);
  
  res.on("finish", () => {
    console.log(`Response: ${res.statusCode}`);
  });
  
  next();
}

app.use(loggingMiddleware);
app.use(paymentMiddleware(...));
```

---

## Best Practices

<AccordionGroup>
  <Accordion title="Use Environment Variables">
    ```typescript
    // ✅ Good
    const evmAddress = process.env.EVM_ADDRESS;
    
    // ❌ Bad
    const evmAddress = "0x5d791e3554d0e83f171126905bda1640bf6f9a8b";
    ```
  </Accordion>

  <Accordion title="Validate Configuration">
    ```typescript
    if (!evmAddress || !facilitatorUrl) {
      console.error("Missing required configuration");
      process.exit(1);
    }
    ```
  </Accordion>

  <Accordion title="Query /supported on Startup">
    ```typescript
    async function getTreasuryAddress(): Promise<string> {
      const response = await fetch(`${facilitatorUrl}/supported`);
      const data = await response.json();
      return data.signers["eip155:*"][0];
    }
    
    const treasuryAddress = await getTreasuryAddress();
    ```
  </Accordion>

  <Accordion title="Use TypeScript">
    ```typescript
    // Type safety prevents configuration errors
    const evmAddress: `0x${string}` = process.env.EVM_ADDRESS as `0x${string}`;
    ```
  </Accordion>
</AccordionGroup>

---

## Migration: v1 → v2

### Step-by-Step

<Steps>
  <Step title="Update Dependencies">
    ```bash
    npm uninstall x402-express
    npm install @x402/express @x402/evm @x402/core
    ```
  </Step>
  
  <Step title="Update Imports">
    ```typescript
    // Before (v1)
    import { paymentMiddleware } from "x402-express";
    
    // After (v2)
    import { paymentMiddleware, x402ResourceServer } from "@x402/express";
    import { ExactEvmScheme } from "@x402/evm/exact/server";
    import { HTTPFacilitatorClient } from "@x402/core/server";
    ```
  </Step>
  
  <Step title="Update Middleware Config">
    ```typescript
    // Before (v1)
    app.use(
      paymentMiddleware(
        payTo,
        { "GET /weather": { price: "$0.011", network: "base-sepolia" } },
        { url: facilitatorUrl }
      )
    );
    
    // After (v2)
    const client = new HTTPFacilitatorClient({ url: facilitatorUrl });
    
    app.use(
      paymentMiddleware(
        {
          "GET /weather": {
            accepts: [{
              scheme: "exact",
              price: "$0.011",
              network: "eip155:84532",
              payTo: evmAddress,
            }]
          }
        },
        new x402ResourceServer(client).register("eip155:84532", new ExactEvmScheme())
      )
    );
    ```
  </Step>
  
  <Step title="Update Network Identifiers">
    | v1 | v2 |
    |----|-----|
    | `"base-sepolia"` | `"eip155:84532"` |
    | `"base"` | `"eip155:8453"` |
  </Step>
</Steps>

---

## Next Steps

<CardGroup cols={2}>
  <Card title="Treasury-First Architecture" icon="building-columns" href="/treasury-first">
    Understand payment flow
  </Card>
  
  <Card title="x402 Integration Guide" icon="book" href="/x402-integration">
    Complete reference
  </Card>
  
  <Card title="API Reference" icon="code" href="/api-reference/introduction">
    Explore all endpoints
  </Card>
  
  <Card title="Error Handling" icon="triangle-exclamation" href="/api-reference/errors">
    Handle errors properly
  </Card>
</CardGroup>

<Check>
**You're ready!** Your server is now accepting x402 payments with treasury-first architecture.
</Check>